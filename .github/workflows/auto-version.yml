name: ğŸš€ Auto Version & Changelog Update

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

jobs:
  auto-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“‹ Get Commit Info
      id: commit_info
      run: |
        # Obter mensagem do Ãºltimo commit
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
        
        # Determinar tipo de versÃ£o
        COMMIT_LOWER=$(echo "$COMMIT_MSG" | tr '[:upper:]' '[:lower:]')
        
        if echo "$COMMIT_LOWER" | grep -q "breaking\|major\|incompatible"; then
          echo "version_type=major" >> $GITHUB_OUTPUT
        elif echo "$COMMIT_LOWER" | grep -q "feat\|feature\|minor\|add\|new\|funcionalidade"; then
          echo "version_type=minor" >> $GITHUB_OUTPUT  
        elif echo "$COMMIT_LOWER" | grep -q "fix\|patch\|bug\|correÃ§Ã£o\|ajuste"; then
          echo "version_type=patch" >> $GITHUB_OUTPUT
        else
          echo "version_type=patch" >> $GITHUB_OUTPUT
        fi
        
        echo "Commit: $COMMIT_MSG"
        echo "Type detected: $(echo "$COMMIT_LOWER" | grep -q "feat\|feature" && echo "minor" || echo "patch")"

    - name: ğŸ“Š Show Current Version
      run: |
        echo "ğŸ“‹ VersÃ£o atual:"
        python version_manager.py show
        
        echo "ğŸ“ Arquivos de versÃ£o:"
        echo "VERSION: $(cat VERSION 2>/dev/null || echo 'nÃ£o encontrado')"
        echo "package.json: $(grep '"version"' frontend/frontend/package.json 2>/dev/null || echo 'nÃ£o encontrado')"

    - name: ğŸ”„ Update Version & Changelog
      id: update_version
      run: |
        echo "ğŸš€ Atualizando versÃ£o (${{ steps.commit_info.outputs.version_type }})..."
        
        # Executar version_manager.py
        python version_manager.py ${{ steps.commit_info.outputs.version_type }}
        
        # Obter nova versÃ£o
        NEW_VERSION=$(cat VERSION)
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        echo "âœ… Nova versÃ£o: $NEW_VERSION"

    - name: ğŸ“ Customize Changelog Entry
      run: |
        echo "ğŸ“ Personalizando entrada do changelog..."
        
        # Script Python para personalizar changelog baseado na mensagem do commit
        python3 << 'EOF'
        import json
        import os
        from pathlib import Path
        
        commit_msg = """${{ steps.commit_info.outputs.commit_message }}"""
        version_type = "${{ steps.commit_info.outputs.version_type }}"
        new_version = "${{ steps.update_version.outputs.new_version }}"
        
        # Ler changelog atual
        changelog_path = Path("CHANGELOG.json")
        if changelog_path.exists():
            with open(changelog_path, 'r', encoding='utf-8') as f:
                changelog = json.load(f)
        else:
            changelog = {"versions": []}
        
        # Encontrar a versÃ£o mais recente (que acabou de ser criada)
        if changelog["versions"] and changelog["versions"][0]["version"] == new_version:
            latest_version = changelog["versions"][0]
            
            # Personalizar baseado na mensagem do commit
            commit_lower = commit_msg.lower()
            
            # Extrair tÃ­tulo mais especÃ­fico da mensagem
            if ':' in commit_msg:
                title_part = commit_msg.split(':', 1)[1].strip()
                latest_version["title"] = title_part[:50] + ("..." if len(title_part) > 50 else "")
            
            # Personalizar mudanÃ§as baseado no tipo e conteÃºdo
            changes = []
            
            if "feat" in commit_lower or "feature" in commit_lower:
                changes.append({
                    "type": "feature",
                    "title": "Nova Funcionalidade",
                    "description": commit_msg.split(':', 1)[1].strip() if ':' in commit_msg else commit_msg
                })
            elif "fix" in commit_lower or "bug" in commit_lower:
                changes.append({
                    "type": "fix", 
                    "title": "CorreÃ§Ã£o de Bug",
                    "description": commit_msg.split(':', 1)[1].strip() if ':' in commit_msg else commit_msg
                })
            elif "improvement" in commit_lower or "melhoria" in commit_lower:
                changes.append({
                    "type": "improvement",
                    "title": "Melhoria",
                    "description": commit_msg.split(':', 1)[1].strip() if ':' in commit_msg else commit_msg
                })
            elif "security" in commit_lower or "seguranÃ§a" in commit_lower:
                changes.append({
                    "type": "security",
                    "title": "CorreÃ§Ã£o de SeguranÃ§a", 
                    "description": commit_msg.split(':', 1)[1].strip() if ':' in commit_msg else commit_msg
                })
            else:
                # PadrÃ£o baseado no tipo de versÃ£o
                if version_type == "major":
                    changes.append({
                        "type": "feature",
                        "title": "AtualizaÃ§Ã£o Principal",
                        "description": commit_msg
                    })
                elif version_type == "minor":
                    changes.append({
                        "type": "feature", 
                        "title": "Nova Funcionalidade",
                        "description": commit_msg
                    })
                else:
                    changes.append({
                        "type": "fix",
                        "title": "Melhorias Gerais",
                        "description": commit_msg
                    })
            
            # Atualizar changes se nÃ£o estiver vazio
            if changes:
                latest_version["changes"] = changes
            
            # Salvar changelog atualizado
            with open(changelog_path, 'w', encoding='utf-8') as f:
                json.dump(changelog, f, indent=2, ensure_ascii=False)
            
            # Copiar para frontend/public
            import shutil
            frontend_path = Path("frontend/frontend/public/CHANGELOG.json")
            if frontend_path.parent.exists():
                shutil.copy2(changelog_path, frontend_path)
            
            print(f"âœ… Changelog personalizado para versÃ£o {new_version}")
            print(f"ğŸ“ TÃ­tulo: {latest_version.get('title', 'N/A')}")
            print(f"ğŸ”§ MudanÃ§as: {len(changes)} entrada(s)")
        EOF

    - name: ğŸ—ï¸ Build Frontend
      run: |
        echo "ğŸ—ï¸ Compilando frontend com nova versÃ£o..."
        cd frontend/frontend
        
        # Instalar dependÃªncias se necessÃ¡rio
        if [ ! -d "node_modules" ]; then
          npm install
        fi
        
        # Build do frontend
        npm run build
        
        echo "âœ… Frontend compilado com versÃ£o ${{ steps.update_version.outputs.new_version }}"

    - name: ğŸ“¤ Commit & Push Changes
      run: |
        echo "ğŸ“¤ Fazendo commit das mudanÃ§as..."
        
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Adicionar arquivos modificados
        git add VERSION
        git add frontend/frontend/package.json
        git add frontend/frontend/package-lock.json
        git add frontend/frontend/pnpm-lock.yaml
        git add backend/niochat/settings.py
        git add backend/core/telegram_service.py  
        git add CHANGELOG.json
        git add frontend/frontend/public/CHANGELOG.json
        git add VERSION_INFO.md
        git add frontend/frontend/dist/ || true
        
        # Verificar se hÃ¡ mudanÃ§as
        if git diff --staged --quiet; then
          echo "â­ï¸ Nenhuma mudanÃ§a de versÃ£o detectada"
        else
          # Fazer commit
          git commit -m "ğŸ¤– Auto-update version to ${{ steps.update_version.outputs.new_version }} [skip ci]"
          
          # Push das mudanÃ§as
          git push origin ${{ github.ref_name }}
          
          echo "âœ… VersÃ£o ${{ steps.update_version.outputs.new_version }} commitada e enviada!"
        fi

    - name: ğŸ·ï¸ Create Release Tag
      if: steps.update_version.outputs.new_version != ''
      run: |
        echo "ğŸ·ï¸ Criando tag de release..."
        
        NEW_VERSION="${{ steps.update_version.outputs.new_version }}"
        
        # Criar tag
        git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
        
        # Push da tag
        git push origin "v$NEW_VERSION"
        
        echo "âœ… Tag v$NEW_VERSION criada!"

    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸ‰ Versionamento AutomÃ¡tico ConcluÃ­do!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **VersÃ£o anterior:** $(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
        echo "- **Nova versÃ£o:** ${{ steps.update_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tipo:** ${{ steps.commit_info.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ steps.commit_info.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Arquivos Atualizados:" >> $GITHUB_STEP_SUMMARY
        echo "- VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- frontend/frontend/package.json" >> $GITHUB_STEP_SUMMARY
        echo "- CHANGELOG.json" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend build atualizado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ **Sistema em produÃ§Ã£o atualizado automaticamente!**" >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: auto-version
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ‰ Success Notification
      run: |
        echo "âœ… Versionamento automÃ¡tico executado com sucesso!"
        echo "ğŸ”— Verifique o changelog em: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.json"



